<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>JIRA统计</title>
    <style>
        .jira-table {
            border-collapse: collapse;
            margin: 0 auto;
        }
        
        .jira-table td {
            border: 1px solid #999;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            padding: 3px 5px;
            font-size: 12px;
            background: #FFF;
        }
        
        .jira-table .data .highlight {
            color: red;
        }
        
        .jira-table .data .blue {
            color: blue;
        }
        
        .jira-table .data .detail {
            color: #777;
            text-align: left;
            white-space: nowrap;
        }
        
        .jira-table .header td {
            background: #DEDEDE;
        }
        
        .jira-table .footer td {
            background: #CCC;
        }
    </style>
</head>

<body>
</body>
<script src="../js/plugin/jquery.min.js"></script>
<script>
    function getQueryParam(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)');
        var r = window.location.search.substr(1).match(reg);
        if (r !== null) return unescape(r[2]);
        return '';
    }

    function formatCellJira(person, type, row, detail) {
        var jira = person[type];
        if (!jira) {
            row.push('', '');
        } else {
            row.push(' ' + jira.total);
            detail[type] = jira;
            if (jira.names) {
                row.push(jira.jira.toString());
            } else {
                var info = [],
                    idx = 0;
                for (var name in jira) {
                    if (['total', 'score'].indexOf(name) !== -1) continue;
                    var jiraInfo = jira[name];
                    info.push((++idx) + '. ' + name + ' （数量：' + jiraInfo.total /* + ', 得分：' + jiraInfo.score*/ + '）');
                }
                row.push(info.join('<br>'));
            }
        }
    }

    function getTypeNames(jiras) {
        return ['当前版本开发新增', '之前版本开发新增', '维护模块历史遗留'];
        var typeNames = [];
        for (var person in jiras) {
            var jira = jiras[person];
            for (var name in jira) {
                if (!/[a-z]+/.test(name) && typeNames.indexOf(name) === -1) {
                    typeNames.push(name);
                }
            }
        }
        return typeNames;
    }

    function orderPush(list, cmp, idx, from) {
        var total = cmp[idx];
        for (var i = from, len = list.length; i < len; i++) {
            if (list[i][idx] <= total) {
                list.splice(i, 0, cmp);
                return;
            }
        }
        list.push(cmp);
    }

    function sumColumn(datas, col, fr) {
        var sum = 0;
        for (var r = fr, rlen = datas.length - 1; r < rlen; r++) {
            sum += (parseInt(datas[r][col]) || 0)
        }
        return sum;
    }

    function parseBasic(basic) {
        var str = basic.split(';'),
            json = {};
        for (var i = 0, len = str.length; i < len; i++) {
            var person = str[i].split(':');
            json[person[0]] = parseInt(person[1]) || 0;
        }
        return json;
    }

    function getRate(datas, basic) {
        return basic ? (((parseInt(datas[3]) || 0) + (parseInt(datas[5]) || 0)) / basic).toFixed(2) : '-';
    }

    function formatPrint(jiras, basic) {
        var typeNames = getTypeNames(jiras);
        var table = [
                [{
                    value: '序号',
                    rs: 2
                }, {
                    value: '姓名',
                    rs: 2
                }, {
                    value: '总BUG数',
                    rs: 2
                }],
                [undefined, undefined, undefined]
            ],
            idx = 1;
        typeNames.every(function(item) {
            table[0].push({
                value: item,
                cs: 2
            }, undefined);
            table[1].push('BUG数', '详情');
            return true;
        });
        table[0].push({
            value: '功能点数',
            rs: 2
        }, {
            value: 'BUG率',
            rs: 2
        });
        var sumBasic = 0;
        for (var name in jiras) {
            var person = jiras[name],
                detail = {},
                row = [undefined, name, person.total];
            for (var i = 0, len = typeNames.length; i < len; i++) {
                formatCellJira(person, typeNames[i], row, detail);
            }
            var countBasic = basic[name] || 0;
            delete basic[name];
            sumBasic += countBasic;
            row.push(countBasic, getRate(row, countBasic));
            orderPush(table, row, 2, 2);
        }
        for (var person in basic) {
            var row = [undefined, person, 0];
            typeNames.every(function(item) {
                row.push(0, '');
                return true;
            });
            row.push(basic[person], 0);
            sumBasic += basic[person];
            table.push(row);
        }
        for (var i = 2, len = table.length; i < len; i++) {
            table[i][0] = idx++;
        }
        var count = table.length,
            lastRow = [{
                value: '合计',
                cs: 2
            }, undefined, sumColumn(table, 2, 2)];
        typeNames.every(function(item, idx) {
            lastRow.push(sumColumn(table, 3 + idx * 2, 2), '');
            return true;
        });
        lastRow.push(sumBasic, getRate(lastRow, sumBasic));
        table.push(lastRow);
        return table;
    }
    var timer = 0,
        count = 3;
    (function _() {
        document.body.innerHTML = '<h4 style="width: 280px; margin: 0 auto; margin-top: 100px; ">可能会比较耗时，正在玩命加载中 ' + new Array(count + 1).join('. ') + '</h4>';
        count = count % 3 + 1;
        timer = setTimeout(_, 500);
    })()
    var basic = window.prompt('请输入功能点数：(姓名与功能点间用":"，人员间用";")')
    $.ajax({
        url: '/jira',
        data: 'version=' + getQueryParam('version'),
        method: 'GET',
        success: function(data) {
            clearTimeout(timer);
            try {
                data = JSON.parse(data);
                console.log(data);
                var fmDatas = formatPrint(data, parseBasic(basic));
                var htmls = ['<h3 style="text-align: center;">版本【', (getQueryParam('version') || 'Site V1.9.0').split(';').join(' - '), '】BUG情况汇总</h3>', '<table class="jira-table">'];
                for (var r = 0, rlen = fmDatas.length; r < rlen; r++) {
                    htmls.push('<tr class="', r < 2 ? 'header' : r === rlen - 1 ? 'footer' : 'data', '">');
                    var rowData = fmDatas[r];
                    for (var c = 0, clen = rowData.length; c < clen; c++) {
                        var data = rowData[c];
                        if (data === undefined) continue;
                        htmls.push('<td');
                        if (data && data.rs) {
                            htmls.push(' rowSpan="', data.rs, '"');
                        }
                        if (data && data.cs) {
                            htmls.push(' colSpan="', data.cs, '"');
                        }
                        if (/^1\..+[\u4e00-\u9fa5]+/.test(data)) {
                            htmls.push(' class="detail"');
                        } else if (c === 2 || c === clen - 1) {
                            htmls.push(' class="highlight"');
                        } else if (c === clen - 2) {
                            htmls.push(' class="blue"');
                        }
                        htmls.push('>', data.value || data, '</td>');
                    }
                    htmls.push('</tr>');
                }
                htmls.push('</table>');
                document.body.innerHTML = htmls.join('');
            } catch (e) {
                document.body.innerHTML = data;
                console.log(e);
            }
        }
    });
</script>

</html>